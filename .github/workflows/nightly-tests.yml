name: ðŸŒ™ Nightly Comprehensive Tests

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      full_suite:
        description: 'Run full test suite including stress tests'
        required: true
        default: true
        type: boolean

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read

env:
  NODE_VERSION: '20'

jobs:
  comprehensive-test:
    name: ðŸ” Comprehensive Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        environment: [staging, production]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: ðŸ§ª Run Full Test Suite
        run: |
          npx playwright test --project=${{ matrix.browser }} --grep="@smoke|@regression|@critical"
        env:
          TEST_ENV: ${{ matrix.environment }}
          FULL_SUITE: ${{ github.event.inputs.full_suite || 'true' }}

      - name: ðŸ“Š Generate Comprehensive Reports
        if: always()
        run: |
          npm run ctrf:summary
          npm run ai:report
        continue-on-error: true

      - name: ðŸ“§ Send Failure Notification
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const title = `ðŸš¨ Nightly Test Failure - ${{ matrix.browser }} on ${{ matrix.environment }}`;
              const body = `
              Nightly test run failed for:
              - Browser: ${{ matrix.browser }}
              - Environment: ${{ matrix.environment }}
              - Run: ${{ github.run_id }}
              - Workflow: ${{ github.workflow }}
              - Commit: ${{ github.sha }}
              
              Please check the logs and reports for details:
              ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              `;
              
              const response = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bug', 'nightly-test', 'automation']
              });
              
              console.log(`âœ… Issue created successfully: #${response.data.number}`);
            } catch (error) {
              console.log(`âŒ Failed to create issue: ${error.message}`);
              console.log(`ðŸ“‹ Would have created issue with title: ðŸš¨ Nightly Test Failure - ${{ matrix.browser }} on ${{ matrix.environment }}`);
              
              // Still fail the step to indicate the notification couldn't be sent
              throw new Error(`Issue creation failed: ${error.message}`);
            }
        continue-on-error: true

      - name: ðŸ“‹ Upload Comprehensive Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-reports-${{ matrix.browser }}-${{ matrix.environment }}
          path: |
            playwright-report/
            ctrf/
            ai-reports/
            test-results/
          retention-days: 7

  performance-test:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: âš¡ Run Performance Tests
        run: |
          npx playwright test --project=chromium --grep="@performance"
        continue-on-error: true

      - name: ðŸ“ˆ Upload Performance Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: |
            playwright-report/
            test-results/
          retention-days: 14

  weekly-report:
    name: ðŸ“Š Weekly Test Report
    runs-on: ubuntu-latest
    needs: [comprehensive-test, performance-test]
    if: always() && github.event.schedule == '0 2 * * 0'  # Only on Sunday
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download all reports
        uses: actions/download-artifact@v4
        with:
          path: weekly-reports/

      - name: ðŸ“Š Generate Weekly Summary
        run: |
          echo "# ðŸ“Š Weekly Test Summary" > weekly-summary.md
          echo "Generated on: $(date)" >> weekly-summary.md
          echo "" >> weekly-summary.md
          
          # Count test files and add summary
          find weekly-reports -name "*.json" | wc -l | xargs echo "Total test report files:" >> weekly-summary.md
          
          # Add more detailed analysis here if needed
        
      - name: ðŸ“§ Create Weekly Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('weekly-summary.md', 'utf8');
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“Š Weekly Test Report - Week of ${new Date().toISOString().split('T')[0]}`,
              body: summary,
              labels: ['report', 'weekly', 'automation']
            });
